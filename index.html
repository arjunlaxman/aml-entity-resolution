<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AML Neural Monitor | Live AI System</title>
    <style>
        /* [Keep the exact same CSS from the previous index.html file] */
        /* I am omitting the CSS block for brevity, paste the previous CSS here */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; }
        .header { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(71, 85, 105, 0.3); padding: 1.5rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        h1 { font-size: 1.75rem; font-weight: 700; background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .run-btn { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; padding: 0.75rem 2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 1rem; padding: 1.5rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-label { color: #94a3b8; font-size: 0.875rem; text-transform: uppercase; }
        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
        .panel { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 1rem; padding: 1.5rem; min-height: 500px; }
        .anomaly-card { background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(71, 85, 105, 0.3); padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; cursor: pointer; transition: 0.2s; }
        .anomaly-card:hover, .anomaly-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; }
        .badge-CRITICAL { background: #ef4444; color: white; }
        .badge-HIGH { background: #f97316; color: white; }
        .badge-MEDIUM { background: #eab308; color: black; }
        .loading { text-align: center; padding: 2rem; color: #94a3b8; }
        .viz-container { height: 400px; width: 100%; background: rgba(0,0,0,0.2); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <div>
                    <h1>AML Neural Monitor</h1>
                    <div style="font-size: 0.9rem; color: #94a3b8">Connected to: <span style="color: #10b981">‚óè Live Python API</span></div>
                </div>
            </div>
            <button id="runBtn" class="run-btn" onclick="triggerPipeline()">
                ‚ö° Retrain & Analyze
            </button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-tx">0</div>
                <div class="stat-label">Transactions Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-anom" style="color: #ef4444">0</div>
                <div class="stat-label">Anomalies Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-ent">0</div>
                <div class="stat-label">Entities Monitored</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-risk">--</div>
                <div class="stat-label">Global Risk Level</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2 style="margin-bottom: 1rem; font-size: 1.25rem;">‚ö†Ô∏è Detected Threats</h2>
                <div id="anomalyList">
                    <div class="loading">Connecting to ML Backend...</div>
                </div>
            </div>

            <div class="panel">
                <h2 style="margin-bottom: 1rem; font-size: 1.25rem;">üìä Investigation Details</h2>
                <div id="detailPanel">
                    <div class="loading">Select a threat to visualize network</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let anomaliesData = [];

        async function init() {
            try {
                await fetchStats();
                await fetchAnomalies();
            } catch (e) {
                console.error(e);
                document.getElementById('anomalyList').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 2rem;">
                        ‚ùå <strong>Connection Failed</strong><br>
                        Ensure main.py is running on port 8000
                    </div>`;
            }
        }

        async function fetchStats() {
            const res = await fetch(`${API_URL}/stats`);
            const data = await res.json();
            document.getElementById('stat-tx').textContent = data.transaction_count.toLocaleString();
            document.getElementById('stat-anom').textContent = data.anomaly_count;
            document.getElementById('stat-ent').textContent = data.entity_count.toLocaleString();
            document.getElementById('stat-risk').textContent = data.risk_level;
        }

        async function fetchAnomalies() {
            const res = await fetch(`${API_URL}/anomalies`);
            anomaliesData = await res.json();
            renderAnomalies(anomaliesData);
        }

        function renderAnomalies(data) {
            const list = document.getElementById('anomalyList');
            if (data.length === 0) {
                list.innerHTML = '<div class="loading">No anomalies detected. System Clean.</div>';
                return;
            }
            list.innerHTML = data.map((item, idx) => `
                <div class="anomaly-card" onclick="loadCase('${item.id}', ${idx})">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>${item.type}</strong>
                        <span class="badge badge-${item.severity}">${item.severity}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #94a3b8;">${item.description}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; display: flex; justify-content: space-between;">
                        <span style="color: #ef4444">Risk: ${(item.riskScore * 100).toFixed(1)}%</span>
                        <span style="color: #10b981">$${item.totalAmount.toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadCase(caseId, idx) {
            // Highlight active card
            document.querySelectorAll('.anomaly-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.anomaly-card')[idx].classList.add('active');

            const panel = document.getElementById('detailPanel');
            panel.innerHTML = '<div class="loading">Fetching Graph Data...</div>';

            // Fetch graph data
            const res = await fetch(`${API_URL}/graph/${caseId}`);
            const graphData = await res.json();
            
            const anomaly = anomaliesData[idx];

            panel.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem">${anomaly.type}</h3>
                    <p style="color: #94a3b8">${anomaly.description}</p>
                </div>
                
                <div class="viz-container">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üï∏Ô∏è</div>
                        <div>Graph Loaded: ${graphData.entities.length} Entities, ${graphData.transactions.length} Transactions</div>
                        <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">(Canvas visualization would render here using D3.js or Cytoscape)</div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem;">
                        <h4>Entities Involved</h4>
                        <ul style="margin-top: 0.5rem; padding-left: 1.2rem; font-size: 0.9rem; color: #cbd5e1;">
                            ${graphData.entities.map(e => `<li>${e.name} (${e.type}) - Risk: ${(e.risk*100).toFixed(0)}%</li>`).join('')}
                        </ul>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem;">
                        <h4>ML Confidence</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">${(anomaly.riskScore * 100).toFixed(1)}%</div>
                        <div style="font-size: 0.8rem; color: #94a3b8">Based on Isolation Forest & Graph Analysis</div>
                    </div>
                </div>
            `;
        }

        async function triggerPipeline() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.innerText = '‚è≥ Running Pipeline...';
            
            await fetch(`${API_URL}/run_analysis`, { method: 'POST' });
            
            // Poll for completion (simplified for demo)
            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = '‚ö° Retrain & Analyze';
                init(); // Refresh data
            }, 5000);
        }

        init();
    </script>
</body>
</html>
